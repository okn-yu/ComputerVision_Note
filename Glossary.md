## 前提
* 光の反射は拡散反射と鏡面反射の2種類に分類できる
* これは物理現象としては単純化した近似であるが精度が出るためよいとされている

## 物理現象としての光

### フレネル反射率
* 入射光は反射光と屈折光にわかれる
* フレネル反射率は入射光に対する反射光の割合
* フレネル反射率は物質の種類および入射角によって異なる
* 面に対して垂直に入射する場合のフレネル反射率をF0と呼ぶ
* 面に対して水平に入射するほど強く反射する
* F0は金属では0.5-0.9(金属のほうが全然高い)、非金属では0.02-0.2
* 金属のフレネル反射率は物質毎にRGBで異なる。金属の鏡面反射は固有の色が載る
* そのため金属毎にRGBのベクトルを事前に用意する必要がある(=これが金属のベースカラーと思われる)
* 非金属のフレネル反射率はどの物質もRGBで全て同じ。つまり光源の色がそのまま反射される
* https://hanecci.hatenadiary.org/entry/20130525/p3

### 拡散反射
* diffuse
* 物体表面に入射してきた光が、フレネル光学現象の結果、屈折して物体内部に一旦進入し、その物体の内部で様々な方向に散乱を多重に繰り返した結果、再び物体の外に出ていく光
* 光の波長のうち物体内に吸収されてしまう成分も出てくるため、反射光の色合いは光源とは異なり物体固有の色合いとなる
* 例：リンゴなら赤
* 一般にザラザラした物体の表面で強く発生する
* 反射光があらゆる方向に等しいと仮定した理想拡散反射をランバード反射と呼ぶ

### 鏡面反射
* specular
* 物体表面に入射した光が、フレネル光学現象の結果、物体表面でそのまま反射した光
* 光源の光がそのまま反射されるため、基本的には反射光は光源の色合いがそのまま残る
* 一般に滑らかな物体の表面で強く発生する
* 鏡面反射の強度は実際には正反射方向から少しずれた角度でピークをもつ性質がありこれをオフスペキュラーと呼ぶ.

### 表面のラフネス
* ラフネスは表面上の小さな凹凸
* 小さな凹凸は光をあらゆる方向へ跳ね返す
* 完全に滑らかであれば同じ方向へ揃って反射されるために像がくっきりと映る
* 粗い場合は像が散らばるために鮮鋭感が弱くなる
* 前者の例は鏡であり後者の例は粘土

## 計算モデル
#### BSDF(Bidirectional Scattering Distribution Function)
* 双方向散乱分布関数
* BSDF = BRDF + BTDF

#### BRDF(Bidirectional Reflectance Distribution Function)
* 双方向反射率分布関数
* 反射モデルの1つ
* 光の入射方向、物体表面上の光の入射・出射がなされる位置座標、光の出射方向の３つを引数にとる確率密度関数
* ある材質の物体表面のとある位置ｘに、ある方向ω'から光が入射してきた時、別の方向ωへと出射していく光の割合
* 光の入射位置と反射位置は同一と仮定
* BRDFでは反射は「拡散反射」「鏡面反射」「光沢反射」に分類されると仮定
* BRDFの拡散反射は、反射光は入射位置を中心にあらゆる方向に等しく反射すると仮定
* BRDFの鏡面反射は、反射光は入射光の正反射方向に反射すると仮定

#### SVBRDF(Spatially Variant Bidirectional Reflectance Distribution Function)
* 反射モデルの1つ
* 物体表面の場所による差分を考慮したBRDF

#### BSSRDF(Bidirectional Scattering Surface Reflectance Distribution Function)
* 反射モデルの1つ
* 入射した光が物体内部で散乱を繰り返し入射位置とは異なる位置から出射すると仮定
* BSSRDFにおいて入射位置と射出位置が十分に近いと近似するとBRDF
* 光が透過する半透明の物体はBRDFでは不自然になる場合がある

#### BTDF(Bidirectional Transmittance Distribution Function)
* 双方向透過率分布関数
* 光の透過モデルの1つ
* 透過(屈折)現象が入射点と同じ点で起こるという仮定

## BSDFの計算式
* 拡散反射BRDFはランバード反射を仮定
* 鏡面反射BRDFはクック・トランスのクック・トランスのマイクロファセットモデルを仮定
* クック・トランスのモデルは D(h)*F(l, v)*G(v, h)/cos(n, l)cos(n, v)

#### ランバード反射
* DiffuseRefをpiで除算

#### Torrance-Sparrowモデル
* 物体表面は微小面の集合で構成されると仮定し，微小面による遮蔽やフレネル反射を解析することでオフスペキュラーを表現できる物理的に正しいモデルて

#### クック・トランスのモデル
* Torrance-Sparrowモデルの改良
* 分光反射率を用いることで反射光の波長ごとのエネルギー分布を算出し，光源色とは異なる色として観測される金属面で鏡面反射を正確に表現する
* 分子（幾何減衰項）：
* 分子（マイクロファセット分布関数）：物質が滑らかなほど
* 分子（フレネル）：入射ベクトルが物質面に水平に近いほど反射する割合が大きくなる
* 分母：入射ベクトルおよび反射ベクトルが物質面に対して水平に近いほど強く鏡面反射する

#### マイクロファセット分布関数
* 法線分布項
* ミクロな面の法線の向きの分布
* ハーフベクトルと法線方向のなす角の確率密度関数
* すなわちハーフベクトルに対する微小面の法線の゙ばらつき
* 微小面法線分布関数DはBeckmann, Phong, GGX の３種類がある

#### 幾何減衰項
* 微小面によって発生するシャドウイング（自己陰影），マスキング（自己遮蔽）を表す項

#### フレネル
* フレネル反射率の通り

## 金属と非金属
### 金属の拡散反射
* 金属内に進入した光がは散乱により外部に放出されないため拡散反射は存在しない
* よって金属には拡散反射はない
* 現実の金属には表面の汚れや腐食・酸化等による反射光や, 表面の微小な凹凸による正反射光の広がりなどによって拡散反射光 (のように見えるもの) が存在することがある
* また拡散反射光が全く無いと(映り込みの処理をしない場合) 鏡面反射光が弱い部分が真っ黒になり不自然になる
* そこで金属にも鏡面反射係数と似た色の拡散反射係数を設定する場合がある

### 金属の鏡面反射
* 金属の正反射光には色が付く場合がある
* 金属の反射光は,金属表面のごく浅い部分にある自由電子が入射光のエネルギーによって共鳴振動を起こしその振動エネルギーを放出することによって発生する
* このエネルギーの吸収と放出が入射光の波長に対して選択的に行われるために反射光に色が付く
* したがってこの場合は鏡面反射光に色をつけて表現する

### 非金属の拡散反射
### 非金属の鏡面反射
* 非金属の物質では鏡面反射は物体の色の影響を受けることなく光源と同じ色となる

## CVの一般用語
### マテリアル
* 3Dオブジェクトの色の反射に関する特性を決める値

### AO(Ambient Occlusion))
* オブジェクトに遮蔽を用いて陰影を付与する手法
* 形状の凹凸を元にテクスチャに対してグレイスケールの遮蔽の濃淡をマッピングし陰影を強調する効果
* 光学的に正しい影陰ではないがPBRの表現では利用される
* 影ではなく「遮蔽」を用いるため光源の配置によらずに汎用的に使用できる

### 環境光(Ambient)
* 間接光の表現の1つ
* Ambient：場所について、全体の
* オブジェクトの光が当たらない部分(影になる部分)は黒くなる
* 光源から直接当たる光のみを考慮するとオブジェクトに陰が生じる
* 現実のオブジェクトでは間接光により色がついている
* 間接光全てを計算するのは大変であるため疑似的に一定の色を与えるものが「環境光」
* 環境光の代わりに大域照明を用いることもある

### IBL
* イメージ・ベースド・ライティング
* 画像を光源として利用する方法
* 球体や立方体に環境イメージをマッピングし、マッピングしたイメージそのものを光源として環境光を表現
* シーン内に光源（ライト）を設置する必要は必ずしもなく、イメージを光源として活用する点が従来のライティングと最も異なる点
* 一般的なデジタル画像は、RGB （Red / Green / Blue ） の 3チャンネル 256階調 のグレースケール画像で表現
*  IBL では、256階調では光源（ライト）に必要な輝度をカバーする事が出来ません。そこで256階調を超えるダイナミックレンジを持つ特殊な画像が必要
* ＩＢＬを実現するには HDRI （High Dynamic Renge Image） と呼ばれる特殊なイメージフォーマットの画像が必要

### 環境マップ
* 形状に映り込むであろう周囲環境（全周囲の風景）の画像
* キューブマップ：オブジェクトより大きい立方体を配置し6つの内壁に映ったオブジェクトの周囲の空間をテクスチャとして利用
* 球状マップ：全周囲を1枚の2次元画像に表したものであり理論的には視野角360度の魚眼レンズで風景を撮影したのと同じ

### レンダリング方程式
* 真空中での光の輸送・伝達を記述した方程式
* 積分方程式
* パストレーシングの数値計算に用いられる
* 反射・透過する光の量を計算するためにはあらゆる入射方向に関して積分を解く必要があるが一般的には解析的に解くのは困難
* そのためモンテカルロ法などの近似を行う
* レンダリング方程式は大域照明も考慮した式になっているため、解けば大域照明も満たされる

### ボリュームレンダリング方程式
* レンダリング方程式に加えて空間中の媒質における散乱も考慮に加えた方程式

### 大域照明(Global Illumination)
* 間接光の表現の1つ
* 光源から直接届く光の影響だけでなく、他の物体に1回以上反射して間接的に届く光の影響も計算に含めること
* 反射光自体を新たな光源として考慮する（間接照明）
* 大域照明を考慮しない場合はシーン全体が過度に暗くなる
* GIでは自然で柔らかい間接光を表現できる
* フォトンマップ法、ラジオシティ法、ファイナルギャザリング（パストレーシング法）などのアルゴリズムがある
* リアルタイムCGではPRTを用いる

### PRT(Precomputed Radiance Transfer)
* 事前計算放射輝度伝搬
* 大尉域照明をリアルタイムに計算する手法
* 環境マップを丸ごと光源と考え複雑な遮蔽に配慮してリアルタイムレンダリング
* 環境マップは球体で表現可能であり外部光源は環境マップ上の光源
* つまり外部光源は環境マップ上に凹凸として表現される
* 球面調和関数で近似する

### Shading
* 光の角度と光源からの距離を考慮して物体表面の色を変化させることで、物体を実写のようにリアルに表示させる処理
* 日本語では陰影付け
* Shadingの具体的な実行方法は反射モデルを用いた計算

### ライティング
* 3DCG作成における工程の1つ
* 3DCGに光源を設定する
* 仕上げに近い工程
* 3DCGで写実的なリアルさ以外に演出的な効果も考慮する

### レイトレーシング
* モデリング手法の1つ
* カメラから仮想的な光線(ray)を飛ばし、光線と物体が当たっているかどうかを調べることで画面に出す色を決定する
* 1本1本の光線の追跡に多くの計算を必要とするため画像生成に時間がかかる
* 鏡面反射の計算量は増えない
* 透明や鏡面でない物体の表面は周囲のあらゆる方向へ光を乱反射しているため計算量が指数関数的に増える
* 拡散反射は対応しない（そのため柔らかい表現は苦手）
* ただし分散レイトレーシングでは拡散反射は乱数によってランダムに選ばれた方向のみに限定することで計算量を現実的な処理量に抑えたMCRTを用いる
* 放出した光線が（ガラスのような）半透明な面に当たる場合は経路毎に光線を分岐させる

### パストレーシング
* モデリング手法の1つ
* レンダリング方程式に基づいて光の挙動をシミュレーションするアルゴリズム
* レイトレーシングの1つでありレイトレーシングを拡張･強化したレンダリング方法
* モンテカルロ・レイトレーシング(Monte Carlo Ray Tracing, MCRT)と呼ばれる手法の1つ
* モンテカルロ法を用いてレンダリング方程式の解を求める
* パストレーシングでは現実の光の向きとは逆にセンサーから光源までの光輸送経路を考える
* 大域照明を解くMCRTの中では最も基本的な手法
* 入射方向のサンプリング数も基本的には1つに絞る（拡散反射する表面での逆追跡が必要な経路をランダムに1つだけとする）ことで、再帰的な反射・透過を扱いながらも計算量の爆発を抑える
* その場合レンダリング画像には推定結果の分散が視覚的なノイズとして現れるが、パストレーシングを何回も行い平均をとることで分散を低減させる
* BlenderのCyclesはパストレーシング
* 拡散反射にも対応する
* 放出した光線が（ガラスのような）半透明な面に当たる場合は、分岐させずに確率に基づいて経路を決定し複数のサンプリングを元に平均化する

### IOR(Index Of Refraction)
* 屈折率
* 物体固有毎に固有の値をもつ

### アルベド
* 波長ごとの反射率（入射光に対する反射光の比率。この場合は拡散反射・鏡面反射のどちらも含む）
* つまりは色（RGB）ごとの反射率

### TIPS
* CGではRGBのそれぞれに対して拡散反射を決めることができる
* 陰(Shade)は物体が自らに落とす陰
* 影(Shadow)はある物体が他の物体に落とす影


## 参考リンク
* https://qiita.com/emadurandal/items/3a8db7bc61438245654d
* https://book.mynavi.jp/files/topics/54178_ext_90_0.pdf
* https://trap.jp/post/324/
* http://kagamin.net/hole/edupt/edupt_v103.pdf
* http://marina.sys.wakayama-u.ac.jp/~tokoi/?date=20090914
* https://dskjal.com/blender/principled-bsdf.html
* https://blender3d.biz/rendering_renderingmethods.html
* http://marupeke296.com/DXG_No42_HowShouldISetLight.html
* https://news.mynavi.jp/article/graphics-68/
* https://hanecci.hatenadiary.org/entry/20130525/p3
